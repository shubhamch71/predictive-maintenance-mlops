# =============================================================================
# PostgreSQL StatefulSet for MLflow Backend Store
# =============================================================================
# Apply with: kubectl apply -f k8s/mlflow/postgres.yaml
#
# This provides a persistent PostgreSQL database for MLflow to store:
# - Experiment metadata
# - Run information
# - Parameters and metrics
# - Model registry data
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
  namespace: mlops
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: mlflow
type: Opaque
data:
  # Base64 encoded values (change in production!)
  # echo -n 'mlflow' | base64 = bWxmbG93
  # echo -n 'mlflow_password' | base64 = bWxmbG93X3Bhc3N3b3Jk
  # echo -n 'mlflowdb' | base64 = bWxmbG93ZGI=
  POSTGRES_USER: bWxmbG93
  POSTGRES_PASSWORD: bWxmbG93X3Bhc3N3b3Jk
  POSTGRES_DB: bWxmbG93ZGI=
---
# =============================================================================
# ConfigMap for PostgreSQL configuration
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
  namespace: mlops
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: mlflow
data:
  # PostgreSQL configuration
  PGDATA: /var/lib/postgresql/data/pgdata
  # Connection settings
  max_connections: "200"
  shared_buffers: "256MB"
  # Custom initialization script
  init.sql: |
    -- Create MLflow database if not exists
    SELECT 'CREATE DATABASE mlflowdb'
    WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'mlflowdb')\gexec

    -- Grant privileges
    GRANT ALL PRIVILEGES ON DATABASE mlflowdb TO mlflow;

    -- Create extension for better performance
    \c mlflowdb
    CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
---
# =============================================================================
# PostgreSQL StatefulSet
# =============================================================================
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: mlops
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: mlflow
    app.kubernetes.io/version: "15"
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: postgres
      app.kubernetes.io/component: database
  template:
    metadata:
      labels:
        app.kubernetes.io/name: postgres
        app.kubernetes.io/component: database
        app.kubernetes.io/part-of: mlflow
      annotations:
        # Prometheus metrics (if using postgres_exporter)
        prometheus.io/scrape: "true"
        prometheus.io/port: "9187"
    spec:
      # Security context
      securityContext:
        fsGroup: 999
        runAsUser: 999
        runAsNonRoot: true

      # Init container to set permissions
      initContainers:
        - name: init-permissions
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              chown -R 999:999 /var/lib/postgresql/data || true
              chmod 700 /var/lib/postgresql/data || true
          securityContext:
            runAsUser: 0
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/postgresql/data

      containers:
        - name: postgres
          image: postgres:15-alpine
          imagePullPolicy: IfNotPresent

          ports:
            - name: postgres
              containerPort: 5432
              protocol: TCP

          # Environment variables from secret
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_DB
            - name: PGDATA
              valueFrom:
                configMapKeyRef:
                  name: postgres-config
                  key: PGDATA

          # Resource limits
          resources:
            requests:
              cpu: "250m"
              memory: "512Mi"
            limits:
              cpu: "1"
              memory: "2Gi"

          # Volume mounts
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/postgresql/data
            - name: init-scripts
              mountPath: /docker-entrypoint-initdb.d

          # Liveness probe
          livenessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - mlflow
                - -d
                - mlflowdb
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6

          # Readiness probe
          readinessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - mlflow
                - -d
                - mlflowdb
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3

          # Security context
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL

      # Volumes
      volumes:
        - name: init-scripts
          configMap:
            name: postgres-config
            items:
              - key: init.sql
                path: init.sql

      # Termination grace period
      terminationGracePeriodSeconds: 30

      # Node affinity (optional)
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - postgres
                topologyKey: kubernetes.io/hostname

  # Volume claim templates
  volumeClaimTemplates:
    - metadata:
        name: postgres-data
        labels:
          app.kubernetes.io/name: postgres
          app.kubernetes.io/component: database
          app.kubernetes.io/part-of: mlflow
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 10Gi
        # Uncomment and set storage class if needed
        # storageClassName: standard
---
# =============================================================================
# PostgreSQL Service (ClusterIP)
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: mlops
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: mlflow
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
  ports:
    - name: postgres
      port: 5432
      targetPort: 5432
      protocol: TCP
---
# =============================================================================
# PostgreSQL Headless Service (for StatefulSet DNS)
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: postgres-headless
  namespace: mlops
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: mlflow
spec:
  type: ClusterIP
  clusterIP: None
  selector:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
  ports:
    - name: postgres
      port: 5432
      targetPort: 5432
      protocol: TCP
