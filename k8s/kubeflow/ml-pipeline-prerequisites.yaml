# =============================================================================
# Kubeflow ml-pipeline Prerequisites
# =============================================================================
# This manifest creates all required secrets and configmaps for ml-pipeline
# to start successfully. Apply this BEFORE installing Kubeflow Pipelines.
#
# Apply with: kubectl apply -f k8s/kubeflow/ml-pipeline-prerequisites.yaml
# =============================================================================

---
# =============================================================================
# Namespace (Kubeflow uses 'kubeflow' namespace by default)
# =============================================================================
apiVersion: v1
kind: Namespace
metadata:
  name: kubeflow
  labels:
    app.kubernetes.io/name: kubeflow
    istio-injection: disabled  # Disable if not using Istio

---
# =============================================================================
# MySQL Secret for Pipeline Database
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret
  namespace: kubeflow
  labels:
    app.kubernetes.io/name: ml-pipeline
    app.kubernetes.io/component: database
type: Opaque
stringData:
  # IMPORTANT: Change these values in production!
  username: root
  password: pipelines_password_change_me

---
# =============================================================================
# MinIO/S3 Secret for Artifact Storage
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: mlpipeline-minio-artifact
  namespace: kubeflow
  labels:
    app.kubernetes.io/name: ml-pipeline
    app.kubernetes.io/component: artifact-storage
type: Opaque
stringData:
  # IMPORTANT: Change these values in production!
  # For MinIO:
  accesskey: minio
  secretkey: minio123_change_me
  # For AWS S3, use your AWS credentials or use IRSA

---
# =============================================================================
# Pipeline Install ConfigMap
# =============================================================================
# This ConfigMap is referenced by ml-pipeline deployment for configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: pipeline-install-config
  namespace: kubeflow
  labels:
    app.kubernetes.io/name: ml-pipeline
    app.kubernetes.io/component: config
data:
  # Auto-update settings
  autoUpdatePipelineDefaultVersion: "true"

  # Database Configuration (for Pipeline API Server)
  # Option 1: MySQL (default for Kubeflow)
  dbType: mysql
  dbHost: mysql.kubeflow.svc.cluster.local
  dbPort: "3306"
  pipelineDb: mlpipeline

  # MySQL-specific config (legacy keys still used)
  mysqlHost: mysql.kubeflow.svc.cluster.local
  mysqlPort: "3306"

  # Connection pool settings
  ConMaxLifeTime: "300"

  # Object Store Configuration
  # Option 1: MinIO (default for Kubeflow standalone)
  bucketName: mlpipeline
  objectStoreHost: minio-service.kubeflow.svc.cluster.local
  objectStorePort: "9000"

  # For AWS S3 (uncomment when using EKS):
  # bucketName: your-s3-bucket-name
  # objectStoreHost: s3.amazonaws.com
  # objectStorePort: "443"

---
# =============================================================================
# MySQL Deployment for Kubeflow (if not using external database)
# =============================================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
  namespace: kubeflow
  labels:
    app.kubernetes.io/name: mysql
    app.kubernetes.io/component: database
spec:
  accessModes:
    - ReadWriteOnce
  # For Docker Desktop: hostpath
  # For EKS: gp3
  storageClassName: hostpath
  resources:
    requests:
      storage: 10Gi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  namespace: kubeflow
  labels:
    app.kubernetes.io/name: mysql
    app.kubernetes.io/component: database
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: mysql
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mysql
        app.kubernetes.io/component: database
    spec:
      containers:
        - name: mysql
          image: mysql:8.0
          env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-secret
                  key: password
            - name: MYSQL_DATABASE
              value: mlpipeline
            - name: MYSQL_ALLOW_EMPTY_PASSWORD
              value: "false"
          ports:
            - containerPort: 3306
              name: mysql
          volumeMounts:
            - name: mysql-data
              mountPath: /var/lib/mysql
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "1"
              memory: "1Gi"
          livenessProbe:
            exec:
              command: ["mysqladmin", "ping", "-h", "localhost"]
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
          readinessProbe:
            exec:
              command: ["mysqladmin", "ping", "-h", "localhost"]
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
      volumes:
        - name: mysql-data
          persistentVolumeClaim:
            claimName: mysql-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: mysql
  namespace: kubeflow
  labels:
    app.kubernetes.io/name: mysql
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: mysql
  ports:
    - port: 3306
      targetPort: 3306
      name: mysql

---
# =============================================================================
# MinIO Deployment for Artifact Storage (if not using S3)
# =============================================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: minio-pvc
  namespace: kubeflow
  labels:
    app.kubernetes.io/name: minio
    app.kubernetes.io/component: storage
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: hostpath
  resources:
    requests:
      storage: 20Gi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: minio
  namespace: kubeflow
  labels:
    app.kubernetes.io/name: minio
    app.kubernetes.io/component: storage
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: minio
  template:
    metadata:
      labels:
        app.kubernetes.io/name: minio
        app.kubernetes.io/component: storage
    spec:
      containers:
        - name: minio
          image: minio/minio:RELEASE.2023-11-20T22-40-07Z
          args:
            - server
            - /data
            - --console-address
            - ":9001"
          env:
            - name: MINIO_ROOT_USER
              valueFrom:
                secretKeyRef:
                  name: mlpipeline-minio-artifact
                  key: accesskey
            - name: MINIO_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mlpipeline-minio-artifact
                  key: secretkey
          ports:
            - containerPort: 9000
              name: api
            - containerPort: 9001
              name: console
          volumeMounts:
            - name: minio-data
              mountPath: /data
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
          livenessProbe:
            httpGet:
              path: /minio/health/live
              port: 9000
            initialDelaySeconds: 30
            periodSeconds: 20
          readinessProbe:
            httpGet:
              path: /minio/health/ready
              port: 9000
            initialDelaySeconds: 10
            periodSeconds: 10
      volumes:
        - name: minio-data
          persistentVolumeClaim:
            claimName: minio-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: minio-service
  namespace: kubeflow
  labels:
    app.kubernetes.io/name: minio
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: minio
  ports:
    - port: 9000
      targetPort: 9000
      name: api
    - port: 9001
      targetPort: 9001
      name: console

---
# =============================================================================
# Init Job to Create MinIO Bucket
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: minio-bucket-init
  namespace: kubeflow
  labels:
    app.kubernetes.io/name: minio
    app.kubernetes.io/component: init
spec:
  ttlSecondsAfterFinished: 600
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-minio
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for MinIO to be ready..."
              until nc -z minio-service.kubeflow.svc.cluster.local 9000; do
                echo "MinIO not ready, waiting..."
                sleep 5
              done
              echo "MinIO is ready!"
      containers:
        - name: create-bucket
          image: minio/mc:latest
          env:
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: mlpipeline-minio-artifact
                  key: accesskey
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: mlpipeline-minio-artifact
                  key: secretkey
          command:
            - sh
            - -c
            - |
              mc alias set myminio http://minio-service.kubeflow.svc.cluster.local:9000 $MINIO_ACCESS_KEY $MINIO_SECRET_KEY
              mc mb myminio/mlpipeline --ignore-existing
              mc anonymous set download myminio/mlpipeline
              echo "Bucket 'mlpipeline' created successfully"
